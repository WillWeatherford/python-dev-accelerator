<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>TCP/IP and Sockets &mdash; Python Dev Accelerator 2.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/pyramid.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Python Dev Accelerator 2.0 documentation" href="../index.html" />
    <link rel="up" title="401 Python: Lecture Notes" href="index.html" />
    <link rel="next" title="SQL Persistence in Python" href="sql_persistence_in_python.html" />
    <link rel="prev" title="Deploying a Simple WSGI Application on AWS" href="simple_wsgi_deployment.html" />
<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Neuton&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Nobile:regular,italic,bold,bolditalic&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->

  </head>
  <body role="document">
<div class="header">
  <div class="logo">
    <a href="../index.html">
      <img class="logo" src="../_static/cf_logo.png" alt="Logo"/>
      <p>Code Fellows</p>
    </a>
  </div>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="sql_persistence_in_python.html" title="SQL Persistence in Python"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="simple_wsgi_deployment.html" title="Deploying a Simple WSGI Application on AWS"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Python Dev Accelerator 2.0 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">401 Python: Lecture Notes</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput > div,
div.nbinput div[class^=highlight],
div.nbinput div[class^=highlight] pre,
div.nboutput,
div.nboutput > div,
div.nboutput div[class^=highlight],
div.nboutput div[class^=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput > :first-child pre {
    color: navy;
}

/* output prompt */
div.nboutput > :first-child pre {
    color: darkred;
}

/* all prompts */
div.nbinput > :first-child[class^=highlight],
div.nboutput > :first-child[class^=highlight],
div.nboutput > :first-child {
    min-width: 11ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}

/* input/output area */
div.nbinput > :nth-child(2)[class^=highlight],
div.nboutput > :nth-child(2),
div.nboutput > :nth-child(2)[class^=highlight] {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
}

/* input area */
div.nbinput > :nth-child(2)[class^=highlight] {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput  > :nth-child(2).stderr {
    background: #fdd;
}

/* ANSI colors */
.ansiblack { color: black; }
.ansired { color: darkred; }
.ansigreen { color: darkgreen; }
.ansiyellow { color: #c4a000; }
.ansiblue { color: darkblue; }
.ansipurple { color: darkviolet; }
.ansicyan { color: steelblue; }
/* See https://github.com/jupyter/nbconvert/issues/174 */
.ansigray { color: gray; }  /* nbconvert CSS */
.ansigrey { color: gray; }  /* nbconvert HTML output */

.ansibgblack { background-color: black; }
.ansibgred { background-color: red; }
.ansibggreen { background-color: green; }
.ansibgyellow { background-color: yellow; }
.ansibgblue { background-color: blue; }
.ansibgpurple { background-color: magenta; }
.ansibgcyan { background-color: cyan; }
.ansibggray { background-color: gray; }

.ansibold { font-weight: bold; }
</style>
<div class="section" id="tcp-ip-and-sockets">
<h1>TCP/IP and Sockets<a class="headerlink" href="#tcp-ip-and-sockets" title="Permalink to this headline">¶</a></h1>
<p>This lecture has some longer code samples which you might want to have on
hand.  They are reproduced in <a class="reference download internal" href="../_downloads/socket_exercises.py"><code class="xref download docutils literal"><span class="pre">socket_exercises.py</span></code></a></p>
<div class="section" id="network-basics">
<h2>Network Basics<a class="headerlink" href="#network-basics" title="Permalink to this headline">¶</a></h2>
<a class="reference internal image-reference" href="../_images/network_topology.png"><img alt="../_images/network_topology.png" class="align-center" src="../_images/network_topology.png" style="width: 45%;" /></a>
<p>image: <a class="reference external" href="http://en.wikipedia.org/wiki/Internet_Protocol_Suite">http://en.wikipedia.org/wiki/Internet_Protocol_Suite</a></p>
<div class="section" id="computer-communications">
<h3>Computer Communications<a class="headerlink" href="#computer-communications" title="Permalink to this headline">¶</a></h3>
<ul class="build simple">
<li>processes can communicate</li>
<li>inside one machine</li>
<li>between two machines</li>
<li>among many machines</li>
</ul>
<a class="reference internal image-reference" href="../_images/data_in_tcpip_stack.png"><img alt="../_images/data_in_tcpip_stack.png" class="align-center" src="../_images/data_in_tcpip_stack.png" style="width: 50%;" /></a>
<p>image: <a class="reference external" href="http://en.wikipedia.org/wiki/Internet_Protocol_Suite">http://en.wikipedia.org/wiki/Internet_Protocol_Suite</a></p>
<ul class="build simple">
<li>This communications is divided into &#8216;layers&#8217;</li>
<li>&#8216;Layers&#8217; are mostly arbitrary</li>
<li>Different descriptions have different layers</li>
<li>Most common is the &#8216;TCP/IP Stack&#8217;</li>
</ul>
</div>
<div class="section" id="the-tcp-ip-stack-link">
<h3>The TCP/IP Stack - Link<a class="headerlink" href="#the-tcp-ip-stack-link" title="Permalink to this headline">¶</a></h3>
<p>The bottom layer is the &#8216;Link Layer&#8217;</p>
<ul class="build simple">
<li>Deals with the physical connections between machines, &#8216;the wire&#8217;</li>
<li>Packages data for physical transport</li>
<li>Executes transmission over a physical medium<ul>
<li>what that medium is is arbitrary</li>
</ul>
</li>
<li>Implemented in the Network Interface Card(s) (NIC) in your computer</li>
</ul>
</div>
<div class="section" id="the-tcp-ip-stack-internet">
<h3>The TCP/IP Stack - Internet<a class="headerlink" href="#the-tcp-ip-stack-internet" title="Permalink to this headline">¶</a></h3>
<p>Moving up, we have the &#8216;Internet Layer&#8217;</p>
<ul class="build simple">
<li>Deals with addressing and routing<ul>
<li>Where are we going and how do we get there?</li>
</ul>
</li>
<li>Agnostic as to physical medium (IP over Avian Carrier - IPoAC)</li>
<li>Makes no promises of reliability</li>
<li>Two addressing systems<ul>
<li>IPv4 (current, limited &#8216;192.168.1.100&#8217;)</li>
<li>IPv6 (future, 3.4 x 10^38 addresses, &#8216;2001:0db8:85a3:0042:0000:8a2e:0370:7334&#8217;)</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="the-tcp-ip-stack-transport">
<h3>The TCP/IP Stack - Transport<a class="headerlink" href="#the-tcp-ip-stack-transport" title="Permalink to this headline">¶</a></h3>
<p>Next up is the &#8216;Transport Layer&#8217;</p>
<ul class="build simple">
<li>Deals with transmission and reception of data<ul>
<li>error correction, flow control, congestion management</li>
</ul>
</li>
<li>Common protocols include TCP &amp; UDP<ul>
<li>TCP: Tranmission Control Protocol</li>
<li>UDP: User Datagram Protocol</li>
</ul>
</li>
<li>Not all Transport Protocols are &#8216;reliable&#8217;<ul>
<li>TCP ensures that dropped packets are resent</li>
<li>UDP makes no such assurance</li>
<li>Reliability is slow and expensive</li>
</ul>
</li>
</ul>
<p>The &#8216;Transport Layer&#8217; also establishes the concept of a <strong>port</strong></p>
<ul class="build simple">
<li>IP Addresses designate a specific <em>machine</em> on the network</li>
<li>A <strong>port</strong> provides addressing for individual <em>applications</em> in a single host</li>
<li>192.168.1.100:80  (the <em>:80</em> part is the <strong>port</strong>)</li>
<li>[2001:db8:85a3:8d3:1319:8a2e:370:7348]:443 (<em>:443</em> is the <strong>port</strong>)</li>
</ul>
<div class="build container">
This means that you don&#8217;t have to worry about information intended for your
web browser being accidentally read by your email client.</div>
</div>
<div class="section" id="ports">
<h3>Ports<a class="headerlink" href="#ports" title="Permalink to this headline">¶</a></h3>
<p>There are certain <strong>ports</strong> which are commonly understood to belong to given
applications or protocols:</p>
<ul class="build simple">
<li>80/443 - HTTP/HTTPS</li>
<li>20 - FTP</li>
<li>22 - SSH</li>
<li>23 - Telnet</li>
<li>25 - SMTP</li>
<li>...</li>
</ul>
<div class="build container">
<p>These ports are often referred to as <strong>well-known ports</strong></p>
<p>(see <a class="reference external" href="http://en.wikipedia.org/wiki/List_of_TCP_and_UDP_port_numbers">http://en.wikipedia.org/wiki/List_of_TCP_and_UDP_port_numbers</a>)</p>
</div>
<p>Ports are grouped into a few different classes</p>
<ul class="build simple">
<li>Ports numbered 0 - 1023 are <em>reserved</em></li>
<li>Ports numbered 1024 - 65535 are <em>open</em></li>
<li>Ports numbered 1024 - 49151 may be <em>registered</em></li>
<li>Ports numbered 49152 - 65535 are called <em>ephemeral</em></li>
</ul>
</div>
<div class="section" id="the-tcp-ip-stack-application">
<h3>The TCP/IP Stack - Application<a class="headerlink" href="#the-tcp-ip-stack-application" title="Permalink to this headline">¶</a></h3>
<p>The topmost layer is the &#8216;Application Layer&#8217;</p>
<p>this is where we live and work</p>
<ul class="build simple">
<li>Deals directly with data produced or consumed by an application</li>
<li>Reads or writes data using a set of understood, well-defined <strong>protocols</strong><ul>
<li>HTTP, SMTP, FTP etc.</li>
</ul>
</li>
<li>Does not know (or need to know) about lower layer functionality<ul>
<li>The exception to this rule is <strong>endpoint</strong> data (or IP:Port)</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="sockets">
<h2>Sockets<a class="headerlink" href="#sockets" title="Permalink to this headline">¶</a></h2>
<p>Think back for a second to what we just finished discussing, the TCP/IP stack.</p>
<ul class="build left simple">
<li>The <em>Internet</em> layer gives us an <strong>IP Address</strong></li>
<li>The <em>Transport</em> layer establishes the idea of a <strong>port</strong>.</li>
<li>The <em>Application</em> layer doesn&#8217;t care about what happens below...</li>
<li><em>Except for</em> <strong>endpoint data</strong> (IP:Port)</li>
</ul>
<div class="build left container">
<p>A <strong>Socket</strong> is the software representation of that endpoint.</p>
<p>Opening a <strong>socket</strong> creates a kind of transceiver that can send and/or
receive <em>bytes</em> at a given IP address and Port.</p>
</div>
<div class="section" id="sockets-in-python">
<h3>Sockets in Python<a class="headerlink" href="#sockets-in-python" title="Permalink to this headline">¶</a></h3>
<div class="build container">
<p>Python provides a standard library module which provides socket functionality.
It is called <strong>socket</strong>.</p>
<p>The library is really just a very thin wrapper around the system
implementation of <em>BSD Sockets</em></p>
<p>Let&#8217;s spend a few minutes getting to know this module.</p>
<p>We&#8217;re going to do this next part together, so open up a terminal and start a
python interpreter</p>
</div>
<p>The Python sockets library allows us to find out what port a <em>service</em> uses:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">socket</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">socket</span><span class="o">.</span><span class="n">getservbyname</span><span class="p">(</span><span class="s1">&#39;ssh&#39;</span><span class="p">)</span>
<span class="go">22</span>
</pre></div>
</div>
<p>You can also do a <em>reverse lookup</em>, finding what service uses a given <em>port</em>:
small</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">socket</span><span class="o">.</span><span class="n">getservbyport</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span>
<span class="go">&#39;http&#39;</span>
</pre></div>
</div>
<p>The sockets library also provides tools for finding out information about
<em>hosts</em>. For example, you can find out about the hostname and IP address of
the machine you are currently using:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
<span class="go">&#39;heffalump.local&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">())</span>
<span class="go">&#39;10.211.55.2&#39;</span>
</pre></div>
</div>
<p>You can also find out about machines that are located elsewhere, assuming you
know their hostname. For example:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="s1">&#39;google.com&#39;</span><span class="p">)</span>
<span class="go">&#39;173.194.33.4&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="s1">&#39;uw.edu&#39;</span><span class="p">)</span>
<span class="go">&#39;128.95.155.135&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="s1">&#39;crisewing.com&#39;</span><span class="p">)</span>
<span class="go">&#39;108.59.11.99&#39;</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">gethostbyname_ex</span></code> method of the <code class="docutils literal"><span class="pre">socket</span></code> library provides more
information about the machines we are exploring:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname_ex</span><span class="p">(</span><span class="s1">&#39;google.com&#39;</span><span class="p">)</span>
<span class="go">(&#39;google.com&#39;, [], [&#39;173.194.33.9&#39;, &#39;173.194.33.14&#39;,</span>
<span class="go">                    ...</span>
<span class="go">                    &#39;173.194.33.6&#39;, &#39;173.194.33.7&#39;,</span>
<span class="go">                    &#39;173.194.33.8&#39;])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname_ex</span><span class="p">(</span><span class="s1">&#39;crisewing.com&#39;</span><span class="p">)</span>
<span class="go">(&#39;crisewing.com&#39;, [], [&#39;108.59.11.99&#39;])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname_ex</span><span class="p">(</span><span class="s1">&#39;www.rad.washington.edu&#39;</span><span class="p">)</span>
<span class="go">(&#39;elladan.rad.washington.edu&#39;, # &lt;- canonical hostname</span>
<span class="go"> [&#39;www.rad.washington.edu&#39;], # &lt;- any machine aliases</span>
<span class="go"> [&#39;128.95.247.84&#39;]) # &lt;- all active IP addresses</span>
</pre></div>
</div>
</div>
<div class="section" id="constructing-a-socket">
<h3>Constructing a Socket<a class="headerlink" href="#constructing-a-socket" title="Permalink to this headline">¶</a></h3>
<p>To create a socket, you use the <strong>socket</strong> method of the <code class="docutils literal"><span class="pre">socket</span></code> library.
It takes up to three optional positional arguments (here we use none to get
the default behavior):</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">foo</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">foo</span>
<span class="go">&lt;socket._socketobject object at 0x10046cec0&gt;</span>
</pre></div>
</div>
<p>A socket has some properties that are immediately important to us. These
include the <em>family</em>, <em>type</em> and <em>protocol</em> of the socket:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">foo</span><span class="o">.</span><span class="n">family</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">foo</span><span class="o">.</span><span class="n">type</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">foo</span><span class="o">.</span><span class="n">proto</span>
<span class="go">0</span>
</pre></div>
</div>
<p>You might notice that the values for these properties are integers.  In fact,
these integers are <strong>constants</strong> defined in the socket library.</p>
</div>
<div class="section" id="a-quick-utility-method">
<h3>A quick utility method<a class="headerlink" href="#a-quick-utility-method" title="Permalink to this headline">¶</a></h3>
<p>Let&#8217;s define a method in place to help us see these constants. It will take a
single argument, the shared prefix for a defined set of constants:</p>
<p><a class="reference download internal" href="../_downloads/socket_exercises.py"><code class="xref download docutils literal"><span class="pre">see</span> <span class="pre">socket_exercises.py</span></code></a></p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">get_constants</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
<span class="gp">... </span>    <span class="sd">&quot;&quot;&quot;mapping of socket module constants to their names.&quot;&quot;&quot;</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
<span class="gp">... </span>        <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">n</span><span class="p">)</span>
<span class="gp">... </span>        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span>
<span class="gp">... </span>        <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
<span class="gp">... </span>    <span class="p">)</span>
<span class="gp">...</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="socket-families">
<h2>Socket Families<a class="headerlink" href="#socket-families" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id1">
<h3>Socket Families<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>Think back a moment to our discussion of the <em>Internet</em> layer of the TCP/IP
stack.  There were a couple of different types of IP addresses:</p>
<ul class="simple">
<li>IPv4 (&#8216;192.168.1.100&#8217;)</li>
<li>IPv6 (&#8216;2001:0db8:85a3:0042:0000:8a2e:0370:7334&#8217;)</li>
</ul>
<p>The <strong>family</strong> of a socket corresponds to the <em>addressing system</em> it uses for
connecting.</p>
<p>Families defined in the <code class="docutils literal"><span class="pre">socket</span></code> library are prefixed by <code class="docutils literal"><span class="pre">AF_</span></code>:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">families</span> <span class="o">=</span> <span class="n">get_constants</span><span class="p">(</span><span class="s1">&#39;AF_&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">families</span>
<span class="go">{0: &#39;AF_UNSPEC&#39;, 1: &#39;AF_UNIX&#39;, 2: &#39;AF_INET&#39;,</span>
<span class="go"> 11: &#39;AF_SNA&#39;, 12: &#39;AF_DECnet&#39;, 16: &#39;AF_APPLETALK&#39;,</span>
<span class="go"> 17: &#39;AF_ROUTE&#39;, 23: &#39;AF_IPX&#39;, 30: &#39;AF_INET6&#39;}</span>
</pre></div>
</div>
<p><em>Your results may vary</em></p>
<p>Of all of these, the ones we care most about are <code class="docutils literal"><span class="pre">2</span></code> (IPv4) and <code class="docutils literal"><span class="pre">30</span></code>
(IPv6).</p>
<p>When you are on a machine with an operating system that is Unix-like, you will
find another generally useful socket family: <code class="docutils literal"><span class="pre">AF_UNIX</span></code>, or Unix Domain
Sockets. Sockets in this family:</p>
<ul class="build simple">
<li>connect processes <strong>on the same machine</strong></li>
<li>are generally a bit slower than IPC connnections</li>
<li>have the benefit of allowing the same API for programs that might run on one
machine __or__ across the network</li>
<li>use an &#8216;address&#8217; that looks like a pathname (&#8216;/tmp/foo.sock&#8217;)</li>
</ul>
</div>
<div class="section" id="test-your-skills">
<h3>Test your skills<a class="headerlink" href="#test-your-skills" title="Permalink to this headline">¶</a></h3>
<p>What is the <em>default</em> family for the socket we created just a moment ago?</p>
<p>(remember we bound the socket to the symbol <code class="docutils literal"><span class="pre">foo</span></code>) center</p>
<p>How did you figure this out?</p>
</div>
</div>
<div class="section" id="socket-types">
<h2>Socket Types<a class="headerlink" href="#socket-types" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id2">
<h3>Socket Types<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>The socket <em>type</em> determines the semantics of socket communications.</p>
<p>Look up socket type constants with the <code class="docutils literal"><span class="pre">SOCK_</span></code> prefix:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">types</span> <span class="o">=</span> <span class="n">get_constants</span><span class="p">(</span><span class="s1">&#39;SOCK_&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">types</span>
<span class="go">{1: &#39;SOCK_STREAM&#39;, 2: &#39;SOCK_DGRAM&#39;,</span>
<span class="go"> ...}</span>
</pre></div>
</div>
<p>The most common are <code class="docutils literal"><span class="pre">1</span></code> (Stream communication (TCP)) and <code class="docutils literal"><span class="pre">2</span></code> (Datagram
communication (UDP)).</p>
</div>
<div class="section" id="id3">
<h3>Test your skills<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>What is the <em>default</em> type for our generic socket, <code class="docutils literal"><span class="pre">foo</span></code>?</p>
</div>
</div>
<div class="section" id="socket-protocols">
<h2>Socket Protocols<a class="headerlink" href="#socket-protocols" title="Permalink to this headline">¶</a></h2>
<p>A socket also has a designated <em>protocol</em>. The constants for these are
prefixed by <code class="docutils literal"><span class="pre">IPPROTO_</span></code>:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">protocols</span> <span class="o">=</span> <span class="n">get_constants</span><span class="p">(</span><span class="s1">&#39;IPPROTO_&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">protocols</span>
<span class="go">{0: &#39;IPPROTO_IP&#39;, 1: &#39;IPPROTO_ICMP&#39;,</span>
<span class="go"> ...,</span>
<span class="go"> 255: &#39;IPPROTO_RAW&#39;}</span>
</pre></div>
</div>
<p>The choice of which protocol to use for a socket is determined by the
<em>internet layer</em> protocol you intend to use. <code class="docutils literal"><span class="pre">TCP</span></code>? <code class="docutils literal"><span class="pre">UDP</span></code>? <code class="docutils literal"><span class="pre">ICMP</span></code>?
<code class="docutils literal"><span class="pre">IGMP</span></code>?</p>
<div class="section" id="id4">
<h3>Test your skills<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>What is the <em>default</em> protocol used by our generic socket, <code class="docutils literal"><span class="pre">foo</span></code>?</p>
</div>
<div class="section" id="custom-sockets">
<h3>Custom Sockets<a class="headerlink" href="#custom-sockets" title="Permalink to this headline">¶</a></h3>
<p>These three properties of a socket correspond to the three positional
arguments you may pass to the socket constructor.</p>
<p>Using them allows you to create sockets with specific communications
profiles:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">bar</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span>
<span class="gp">... </span>                    <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">,</span>
<span class="gp">... </span>                    <span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_UDP</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">bar</span>
<span class="go">&lt;socket._socketobject object at 0x1005b8b40&gt;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="address-information">
<h2>Address Information<a class="headerlink" href="#address-information" title="Permalink to this headline">¶</a></h2>
<div class="left container">
<p>When you are creating a socket to communicate with a remote service, the
remote socket will have a specific communications profile.</p>
<p>The local socket you create must match that communications profile.</p>
<p>How can you determine the <em>correct</em> values to use? center</p>
<p>You ask.</p>
</div>
<div class="section" id="getaddrinfo">
<h3><code class="docutils literal"><span class="pre">getaddrinfo</span></code><a class="headerlink" href="#getaddrinfo" title="Permalink to this headline">¶</a></h3>
<p>The function <code class="docutils literal"><span class="pre">socket.getaddrinfo</span></code> provides information about available
connections on a given host.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
</pre></div>
</div>
<p>This provides all you need to make a proper connection to a socket on a remote
host. The value returned is a tuple of:</p>
<ul class="build simple">
<li>socket family</li>
<li>socket type</li>
<li>socket protocol</li>
<li>canonical name (usually empty, unless requested by flag)</li>
<li>socket address (tuple of IP and Port)</li>
</ul>
<p>Now, ask your own machine what possible connections are available for &#8216;http&#8217;:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">(),</span> <span class="s1">&#39;http&#39;</span><span class="p">)</span>
<span class="go">[(2, 2, 17, &#39;&#39;, (&#39;10.29.144.178&#39;, 80)),</span>
<span class="go"> ...</span>
<span class="go"> (30, 2, 17, &#39;&#39;, (&#39;fe80::e2f8:47ff:fe21:af92%en1&#39;, 80, 0, 5)),</span>
<span class="go"> ...</span>
<span class="go">]</span>
<span class="gp">...</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>What answers do you get?</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">get_address_info</span><span class="p">(</span><span class="s1">&#39;crisewing.com&#39;</span><span class="p">,</span> <span class="s1">&#39;http&#39;</span><span class="p">)</span>
<span class="go">[(2, 2, 17, &#39;&#39;, (&#39;108.168.213.86&#39;, 80)), (2, 1, 6, &#39;&#39;, (&#39;108.168.213.86&#39;, 80))]</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>Try a few other servers you know about.</p>
</div>
</div>
<div class="section" id="communicating">
<h2>Communicating<a class="headerlink" href="#communicating" title="Permalink to this headline">¶</a></h2>
<div class="left container">
<p>Sockets communicate by sending a receiving messages.</p>
<p>Let&#8217;s test this by building a client socket and communicating with a
server.</p>
</div>
<div class="section" id="client-side-communications">
<h3>Client Side Communications<a class="headerlink" href="#client-side-communications" title="Permalink to this headline">¶</a></h3>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Typing this next bit can take some time, and if you aren&#8217;t careful, the
connection you open might time out before you get to the end. The
exercise is reproduced in <a class="reference download internal" href="../_downloads/socket_exercises.py"><code class="xref download docutils literal"><span class="pre">socket_exercises.py</span></code></a></p>
</div>
<p>First, connect and send a message:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">streams</span> <span class="o">=</span> <span class="p">[</span><span class="n">info</span>
<span class="gp">... </span>    <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="s1">&#39;crisewing.com&#39;</span><span class="p">,</span> <span class="s1">&#39;http&#39;</span><span class="p">)</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">info</span> <span class="o">=</span> <span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cewing_socket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cewing_socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;GET / HTTP/1.1</span><span class="se">\r\n</span><span class="s2">&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Host: crisewing.com</span><span class="se">\r\n\r\n</span><span class="s2">&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cewing_socket</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cewing_socket</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SHUT_WR</span><span class="p">)</span>
</pre></div>
</div>
<p>Then, receive a reply, iterating until it is complete:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">buffsize</span> <span class="o">=</span> <span class="mi">4096</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">response</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">done</span> <span class="o">=</span> <span class="bp">False</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">while</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">msg_part</span> <span class="o">=</span> <span class="n">cewing_socket</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">buffsize</span><span class="p">)</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg_part</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">buffsize</span><span class="p">:</span>
<span class="gp">... </span>        <span class="n">done</span> <span class="o">=</span> <span class="bp">True</span>
<span class="gp">... </span>        <span class="n">cewing_socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="gp">... </span>    <span class="n">response</span> <span class="o">+=</span> <span class="n">msg_part</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<span class="go">19427</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cewing_socket</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SHUT_RD</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cewing_socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>There are two basic methods on a socket for sending messages, <code class="docutils literal"><span class="pre">send</span></code> and
<code class="docutils literal"><span class="pre">sendall</span></code>. We&#8217;re using the latter here.</p>
<ul class="build simple">
<li>the transmission continues until all data is sent or an error occurs</li>
<li>success returns <code class="docutils literal"><span class="pre">None</span></code></li>
<li>failure to send raises an error</li>
<li>you can use the type of error to figure out why the transmission failed</li>
<li>if an error occurs you <strong>cannot</strong> know how much, if any, of your data was
sent</li>
</ul>
<p>With <code class="docutils literal"><span class="pre">send</span></code>, you send the message one chunk at a time.  You are responsible
for checking if a particular chunk succeeded or not, and you are also
responsible for determining when the full transmission is done.</p>
<p>The <code class="docutils literal"><span class="pre">recv</span></code> method handles incoming messages in buffers.</p>
<ul class="build simple">
<li>The sole required argument is <code class="docutils literal"><span class="pre">buffer_size</span></code> (an integer). It should be a
power of 2 and smallish (~4096)</li>
<li>It returns a byte string of <code class="docutils literal"><span class="pre">buffer_size</span></code> (or smaller if less data was
received)</li>
<li>If the response is longer than <code class="docutils literal"><span class="pre">buffer</span> <span class="pre">size</span></code>, you can call the method
repeatedly. The last bunch will be less than <code class="docutils literal"><span class="pre">buffer</span> <span class="pre">size</span></code>.</li>
</ul>
<p>Hotice that receiving a message is not a one-and-done kind of thing</p>
<p>We don&#8217;t know how big the incoming message is before we start receiving it.</p>
<p>As a result, we have to use the <code class="docutils literal"><span class="pre">Accumulator</span></code> pattern to gather incoming
buffers of the message until there is no more to get.</p>
<p>The <code class="docutils literal"><span class="pre">recv</span></code> method will return a string less than <code class="docutils literal"><span class="pre">buffsize</span></code> if there isn&#8217;t
any more to come.</p>
<p>Sockets do not have a concept of the &#8220;End Of Transmission&#8221;.</p>
<p>So what happens if the message coming in is an <em>exact multiple of the
buffsize</em>?</p>
<p>There are a couple of strategies for dealing with this. One is to punt to the
<em>application level protocol</em> and allow it to predetermine the size of the
message to come. HTTP works this way</p>
<p>The other is to use the <code class="docutils literal"><span class="pre">shutdown</span></code> method of a socket to close that socket
for reading, writing or both.</p>
<p>When you do so, a 0-byte message is sent to the partner socket, allowing it to
know that you are finished.</p>
<p>For more information, read the <a class="reference external" href="http://docs.python.org/2/howto/sockets.html">Python Socket Programming How-To</a>.</p>
</div>
<div class="section" id="sockets-bytes-and-unicode">
<h3>Sockets, Bytes and Unicode<a class="headerlink" href="#sockets-bytes-and-unicode" title="Permalink to this headline">¶</a></h3>
<div class="build container">
<p>A socket in Python represents an I/O boundary.</p>
<p>That is to say that a socket is a point where data <em>comes into</em> or <em>exits out
from</em> Python.</p>
<p>Best practice is to maintain <em>text</em> internally in Python as <strong>unicode</strong>.</p>
<p>But sockets can only transmit and receive <em>bytes</em>.</p>
<p>You must, therefore, <em>encode</em> unicode objects before attempting to send them
through a socket.</p>
<p>Similarly, you should <em>decode</em> data you&#8217;ve received from a socket if you know
it is meant to be text.</p>
</div>
</div>
</div>
<div class="section" id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Permalink to this headline">¶</a></h2>
<p>Tonight you&#8217;ll put this to work, first by walking through a basic client server
interaction, then by building a basic echo server and client.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">TCP/IP and Sockets</a><ul>
<li><a class="reference internal" href="#network-basics">Network Basics</a><ul>
<li><a class="reference internal" href="#computer-communications">Computer Communications</a></li>
<li><a class="reference internal" href="#the-tcp-ip-stack-link">The TCP/IP Stack - Link</a></li>
<li><a class="reference internal" href="#the-tcp-ip-stack-internet">The TCP/IP Stack - Internet</a></li>
<li><a class="reference internal" href="#the-tcp-ip-stack-transport">The TCP/IP Stack - Transport</a></li>
<li><a class="reference internal" href="#ports">Ports</a></li>
<li><a class="reference internal" href="#the-tcp-ip-stack-application">The TCP/IP Stack - Application</a></li>
</ul>
</li>
<li><a class="reference internal" href="#sockets">Sockets</a><ul>
<li><a class="reference internal" href="#sockets-in-python">Sockets in Python</a></li>
<li><a class="reference internal" href="#constructing-a-socket">Constructing a Socket</a></li>
<li><a class="reference internal" href="#a-quick-utility-method">A quick utility method</a></li>
</ul>
</li>
<li><a class="reference internal" href="#socket-families">Socket Families</a><ul>
<li><a class="reference internal" href="#id1">Socket Families</a></li>
<li><a class="reference internal" href="#test-your-skills">Test your skills</a></li>
</ul>
</li>
<li><a class="reference internal" href="#socket-types">Socket Types</a><ul>
<li><a class="reference internal" href="#id2">Socket Types</a></li>
<li><a class="reference internal" href="#id3">Test your skills</a></li>
</ul>
</li>
<li><a class="reference internal" href="#socket-protocols">Socket Protocols</a><ul>
<li><a class="reference internal" href="#id4">Test your skills</a></li>
<li><a class="reference internal" href="#custom-sockets">Custom Sockets</a></li>
</ul>
</li>
<li><a class="reference internal" href="#address-information">Address Information</a><ul>
<li><a class="reference internal" href="#getaddrinfo"><code class="docutils literal"><span class="pre">getaddrinfo</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#communicating">Communicating</a><ul>
<li><a class="reference internal" href="#client-side-communications">Client Side Communications</a></li>
<li><a class="reference internal" href="#sockets-bytes-and-unicode">Sockets, Bytes and Unicode</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exercises">Exercises</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="simple_wsgi_deployment.html"
                        title="previous chapter">Deploying a Simple WSGI Application on AWS</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="sql_persistence_in_python.html"
                        title="next chapter">SQL Persistence in Python</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="sql_persistence_in_python.html" title="SQL Persistence in Python"
             >next</a> |</li>
        <li class="right" >
          <a href="simple_wsgi_deployment.html" title="Deploying a Simple WSGI Application on AWS"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Python Dev Accelerator 2.0 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >401 Python: Lecture Notes</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2014, Cris Ewing.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.5.
    </div>
  </body>
</html>